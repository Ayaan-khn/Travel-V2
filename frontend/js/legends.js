// ================= LEGENDS DATA =================

const legendsData = [
    {
        id: 1,
        name: "Kashmir Valley",
        location: "Jammu & Kashmir, India",
        mood: "mystical",
        image: "../../assets/Kashmir Valley.png",
        teaser: "Ancient tales speak of a hidden kingdom beneath the frozen lakes, waiting for the worthy to discover its secrets...",
        content: "The Valley of Kashmir has long been known as paradise on Earth, but legends tell of an even greater secret hidden beneath its pristine lakes. Local folk tales speak of 'Satis' - a mystical underground kingdom accessible only to those pure of heart.\n\nThe ancient texts describe how the kingdom was established by celestial beings who sought refuge from the mortal world. Beneath the shimmering waters of Dal Lake, they built palaces of crystal and pearl, where time flows differently than in the world above.\n\nVillagers near the lake have reported strange lights beneath the water on moonless nights, and the melodic sounds of unseen bells. Some believe these are the inhabitants of the hidden kingdom going about their eternal business.",
        facts: [
            "Altitude: 1,850 meters above sea level",
            "Known as 'Paradise on Earth'",
            "Home to ancient Sufi shrines",
            "Famous for floating gardens"
        ],
        stories: "The legendary saint Sheikh Nuruddin Wali is said to have visited the underwater kingdom and returned with wisdom that shaped Kashmir's spiritual heritage. Fishermen still avoid certain parts of the lake, believing they are entrances to the mystical realm."
    },
    {
        id: 2,
        name: "Aberdeen - The Granite City",
        location: "Aberdeenshire, Scotland",
        mood: "haunted",
        image: "../../assets/Aberdeen.png",
        teaser: "The Greyfriars Kirkyard holds secrets that have terrified locals for centuries. Some say the Mackenzie Poltergeist is still searching...",
        content: "Aberdeen's dark past comes alive in the shadowy corners of Greyfriars Kirkyard, one of Scotland's most haunted locations. The city, built on granite that glows silver in moonlight, has been the stage for countless supernatural events throughout the centuries.\n\nThe infamous Mackenzie Poltergeist, also known as 'The Poltergeist of Greyfriars', is said to be the restless spirit of a notorious 17th-century church elder who was murdered in the kirkyard grounds. His spirit has terrorized visitors for over 50 years, attacking anyone who ventures too close to his tomb.\n\nThe city above ground holds its own terrors - the ancient cobblestone streets have witnessed countless executions, and the mist that rolls in from the North Sea is said to carry the whispers of the condemned.",
        facts: [
            "Known as 'The Granite City'",
            "Over 300 years of haunted history",
            "Home to 16th-century coven",
            "Famous castle architecture"
        ],
        stories: "In 1999, a tourist was attacked by an unseen force in the kirkyard, suffering injuries consistent with severe beating - though no one else was present. The incident remains unexplained and the area is now closed to the public after dark."
    },
    {
        id: 3,
        name: "Kyoto - The Ancient Capital",
        location: "Kyoto Prefecture, Japan",
        mood: "peaceful",
        image: "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=800",
        teaser: "In the bamboo groves of Arashiyama, monks have practiced meditation for over a thousand years, achieving enlightenment...",
        content: "Kyoto, the ancient imperial capital of Japan, embodies the soul of traditional Japanese culture. For over a millennium, this city has been the heart of Japanese Buddhism, Shinto spirituality, and artistic achievement.\n\nThe bamboo forests of Arashiyama are said to be pathways to enlightenment. Monks who walked these groves in meditation reportedly achieved states of consciousness that transcended ordinary human experience. The gentle swaying of the bamboo is believed to be the breath of enlightened beings still present in the forest.\n\nAt Fushimi Inari Shrine, thousands of vermillion torii gates create a tunnel to the divine. Each gate represents a donation made by individuals seeking spiritual advancement, creating a physical manifestation of collective spiritual aspiration.",
        facts: [
            "Capital of Japan for 1,100 years",
            "Home to 2,000 temples and shrines",
            "UNESCO World Heritage Site",
            "17 locations designated by UNESCO"
        ],
        stories: "The monks of Kyoto developed unique meditation techniques that influenced Buddhist practice worldwide. The 'forest bathing' traditions pioneered here are now recognized scientifically for their healing properties."
    },
    {
        id: 4,
        name: "Patagonia - The End of the World",
        location: "Patagonia, Chile & Argentina",
        mood: "adventurous",
        image: "https://images.unsplash.com/photo-1531761535209-180857e963b9?w=800",
        teaser: "Legend says the mountains themselves guide those brave enough to climb them to hidden treasures of the ancients...",
        content: "Patagonia, the vast wilderness at the southern tip of South America, has captured human imagination for centuries. The indigenous Mapuche people tell tales of incredible riches hidden in the mountains, guarded by ancient spirits.\n\nThe legendary 'Cave of the Crystals' was discovered in 2000, containing massive selenite crystals that had formed over 500,000 years. Local legends spoke of this place for generations before its scientific discovery, describing it as the heart of the mountain where the Earth stores its most precious energy.\n\nThe Perito Moreno Glacier and the surrounding Andes contain ice caves and frozen waterfalls that locals believe are doorways to parallel dimensions. Adventurers who venture too deep report losing all sense of time, sometimes emerging days later convinced only hours have passed.",
        facts: [
            "Area: 1,043,076 km¬≤",
            "Home to the Patagonian Ice Fields",
            "Third largest freshwater reserve",
            "Inhabited by indigenous Mapuche"
        ],
        stories: "The famous explorer Ernest Shackleton once wrote that the mountains of Patagonia seemed to 'breathe' and 'guide' those who respected them. Modern mountaineers report similar experiences, claiming the peaks themselves seem to choose who is worthy of their summits."
    },
    {
        id: 5,
        name: "Machu Picchu - The Lost City",
        location: "Cusco Region, Peru",
        mood: "mystical",
        image: "https://images.unsplash.com/photo-1587595431973-160d0d94add1?w=800",
        teaser: "High in the Andes, this 15th-century citadel hides secrets of advanced astronomy and spiritual practices that modern science cannot explain...",
        content: "Machu Picchu, the 'Lost City of the Incas', stands as a testament to the incredible engineering and spiritual knowledge of the ancient Inca civilization. Perched at 2,430 meters altitude, this citadel was built with such precision that it remains intact after 500 years.\n\nThe Intihuatana stone, often called the 'Hitching Post of the Sun', was used as an astronomical clock. On the solstice, the sun appears to be tethered to the stone, demonstrating the Incas' advanced understanding of astronomy and their spiritual connection to celestial bodies.\n\nLocal guides speak of energies that emanate from the sacred rocks, particularly at sunrise when the mist lifts and the city emerges from the clouds. Many visitors report feeling profound spiritual experiences that they cannot explain.",
        facts: [
            "Built: c. 1450 AD",
            "Altitude: 2,430 meters",
            "Contains over 150 buildings",
            "Wonder of the World"
        ],
        stories: "The legend of the 'Three Windows' at Machu Picchu speaks of the three original Inca ancestors emerging from caves to populate the world. The city's layout mirrors this creation story, with the Temple of the Three Windows representing the birthplace of humanity."
    },
    {
        id: 6,
        name: "Tower of London",
        location: "London, England",
        mood: "haunted",
        image: "https://images.unsplash.com/photo-1513026705753-bc3fffca8bf4?w=800",
        teaser: "For over 1,000 years, this fortress has witnessed executions, torture, and imprisonment. The spirits of the executed still walk the towers at night...",
        content: "The Tower of London is one of the world's most famous fortified buildings and arguably the most haunted location in England. Since its foundation in 1066, it has served as a royal palace, prison, armory, treasury, and zoo.\n\nThe ghosts of Anne Boleyn, executed in 1536, and Catherine Howard have been seen walking the Tower's corridors, their heads mysteriously missing. Lady Jane Grey, the Nine Days' Queen, appears pleading for her life on the date of her execution.\n\nThe most terrifying apparition is that of the two young princes, Edward V and Richard, murdered in the Tower in 1483. Their ghosts have been reported near the White Tower, clutching each other in terror.",
        facts: [
            "Founded: 1066 by William the Conqueror",
            "22 monarchs have lived here",
            "7 execution took place on Tower Hill",
            "Home to the Crown Jewels"
        ],
        stories: "The Yeoman Warders (Beefeaters) who live in the Tower report constant paranormal activity - doors opening and closing by themselves, unexplained footsteps, and the sound of weeping in the Bloody Tower."
    },
    {
        id: 7,
        name: "Bali - The Island of Gods",
        location: "Bali, Indonesia",
        mood: "peaceful",
        image: "https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=800",
        teaser: "The temples of Bali are said to be inhabited by spirits that dance with the priests during sacred ceremonies...",
        content: "Bali, known as the 'Island of a Thousand Temples', is a living museum of Hindu spirituality and artistic expression. The Balinese believe that their island is a gift from the gods, and every aspect of daily life is intertwined with spiritual practice.\n\nThe sacred monkey forest of Ubud is home to long-tailed macaques who are considered the guardians of the temple. Legend says these monkeys are the reincarnated soldiers of an ancient king, protecting sacred relics hidden throughout the forest.\n\nThe water temples of Tirta Empul are believed to have been created by the god Indra. Pilgrims come from across the world to bathe in its sacred springs, believed to have restorative powers that cleanse both body and soul.",
        facts: [
            "Over 20,000 temples on the island",
            "Population: 4.3 million",
            "Home to unique Hindu tradition",
            "Known as 'Island of the Gods'"
        ],
        stories: "Balinese shamans claim to communicate with the 'Niskala' - the invisible spiritual beings that inhabit every tree, stone, and body of water. During ceremonies, these spirits are said to possess the priests, who enter trance states to deliver messages from the divine realm."
    },
    {
        id: 8,
        name: "Mount Fuji",
        location: "Honshu, Japan",
        mood: "mystical",
        image: "https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?w=800",
        teaser: "Japan's highest mountain is considered sacred. Climbers report supernatural experiences and glimpses into other worlds at the summit...",
        content: "Mount Fuji has been a sacred site for practitioners of Shinto and Buddhism for centuries. As Japan's highest mountain at 3,776 meters, it is believed to be the doorway between the mortal world and the divine realm.\n\nThe mountain has long attracted spiritual practitioners who seek enlightenment through climbing. The 'Diamond Fujisan' - the phenomenon where the mountain appears to glow like a diamond at sunrise - is considered a sacred moment when the veil between worlds is thinnest.\n\nAncient texts describe the mountain as the dwelling place of the goddess Konohanasakuya-hime, and climbers who reach the summit are said to receive her blessing.",
        facts: [
            "Altitude: 3,776 meters",
            "Active stratovolcano",
            "Over 300,000 climb annually",
            "UNESCO World Heritage Site"
        ],
        stories: "Many climbers report seeing 'fuji-gumo' - mysterious cloud formations that appear only near the summit and are interpreted as manifestations of mountain spirits. Some claim to have encountered beings that appear human but speak in languages they cannot understand."
    },
    {
        id: 9,
        name: "New Orleans - The Voodoo Capital",
        location: "Louisiana, USA",
        mood: "haunted",
        image: "https://images.unsplash.com/photo-1568402102990-bc541580b59f?w=800",
        teaser: "In the French Quarter, voodoo priestesses practice ancient arts, and the spirits of the dead refuse to rest...",
        content: "New Orleans is a city where the boundary between the living and the dead is remarkably thin. Built on swampland filled with the remains of thousands of victims of plagues, hurricanes, and violence, the city has developed a unique relationship with the supernatural.\n\nMarie Laveau, the most famous voodoo queen in American history, practiced her art in the French Quarter during the 19th century. Her influence remains so strong that visitors report feeling her presence in the locations where she conducted rituals.\n\nThe St. Louis Cemetery No. 1, where Laveau is buried, contains tombs built above ground due to the water table. These tombs are said to be occupied by spirits who were not properly laid to rest, and paranormal activity is reported regularly.",
        facts: [
            "Founded: 1718",
            "Home to historic voodoo traditions",
            "Above-ground burials due to swamp",
            "Most haunted city in America"
        ],
        stories: "Voodoo practitioners still gather in Louis Armstrong Park on St. John's Eve (June 23rd), continuing traditions started by Marie Laveau. Participants report seeing orbs of light and feeling the presence of spirits who come to receive offerings."
    },
    {
        id: 10,
        name: "Himalayas - Roof of the World",
        location: "Nepal, Tibet, India",
        mood: "adventurous",
        image: "https://images.unsplash.com/photo-1486911278844-a81c5267e227?w=800",
        teaser: "Sacred mountains where monks have achieved enlightenment, and adventurers seek the ultimate challenge that pushes human limits...",
        content: "The Himalayas, meaning 'Abode of Snow' in Sanskrit, contain the highest peaks on Earth and are considered sacred by over 1.5 billion people. Mount Everest, at 8,849 meters, is the roof of the world and has been the ultimate challenge for mountaineers.\n\nFor Tibetan Buddhists, the Himalayas are the physical manifestation of a spiritual realm. The Yeti, or Abominable Snowman, is believed to be a protective spirit of the mountains - not a creature to be feared but a guardian to be respected.\n\nThe monasteries perched on Himalayan cliffs, such as Taktshang in Bhutan, were founded by saints who flew there on the backs of tigers. These sacred sites are places where advanced meditators are said to achieve 'rainbow body' - the transfiguration of the physical body into light at the moment of death.",
        facts: [
            "Total length: 2,400 km",
            "Over 100 peaks above 7,300m",
            "Home to 4th largest ice deposits",
            "Source of major river systems"
        ],
        stories: "Sherpas, the native guides of the Himalayas, speak of 'summit fever' - a supernatural influence that causes climbers to become irrational and disregard danger. Many believe this is caused by mountain spirits testing the resolve of those who seek to reach the top."
    },
    {
        id: 11,
        name: "Stonehenge",
        location: "Wiltshire, England",
        mood: "mystical",
        image: "../../assets/Stonehedge.png",
        teaser: "This prehistoric monument aligned with the sun has stood for 5,000 years. Its true purpose and the people who built it remain a mystery...",
        content: "Stonehenge is one of the most famous prehistoric monuments in the world, dating back to approximately 3000 BC. The circle of massive sarsen stones, each weighing around 25 tons, was constructed using technologies that we do not fully understand today.\n\nThe monument is precisely aligned with the movements of the sun - the heel stone marks the position of the sunrise on the summer solstice, and the center of the monument aligns with the sunset on the winter solstice. This astronomical precision suggests a sophisticated understanding of celestial movements.\n\nAncient folklore claims that the stones were brought from Ireland by the wizard Merlin, or that they are giants who were turned to stone by a witch. Modern pagans consider Stonehenge a sacred site where the veil between worlds is particularly thin.",
        facts: [
            "Built: c. 3000-2000 BC",
            "Original circle: 30 stones",
            "Weighs approximately 4,500 tons",
            "UNESCO World Heritage Site"
        ],
        stories: "Druids, though historically disconnected from Stonehenge's actual builders, have claimed the site as sacred since the 18th century. They perform ceremonies at the solstices, believing the stones channel cosmic energy that can heal and transform those who are open to its power."
    },
    {
        id: 12,
        name: "Sedona - The vortex City",
        location: "Arizona, USA",
        mood: "mystical",
        image: "../../assets/Sedona.png",
        teaser: "Ancient Native American lands where spiritual vortices are said to create healing energy that transforms those who visit...",
        content: "Sedona, Arizona, is renowned worldwide as a center for spiritual healing and personal transformation. The red rock formations that surround the city are believed to contain powerful energy vortices that can accelerate spiritual growth, enhance creativity, and promote physical healing.\n\nThe area has been sacred to Native American tribes for thousands of years. The Yavapai and Apache peoples considered the red rocks to be the living embodiment of their ancestors and spirits, and many sites within the area are still used for ceremonies.\n\nModern spiritual seekers from around the world visit Sedona to experience the vortices, which are said to emanate from the rocks themselves. Some report feeling warmth or tingling, while others describe profound emotional releases or visionary experiences.",
        facts: [
            "Population: 10,000",
            "Famous for red rock formations",
            "Historical Native American lands",
            "Major spiritual tourism destination"
        ],
        stories: "Visitors to Boynton Canyon, one of the main vortex sites, report seeing unexplained lights, hearing voices, and experiencing time distortions. Some claim to have been visited by 'earth spirits' who communicate through feelings and impressions rather than words."
    }
];

// ================= STATE =================

let currentFilter = 'all';
let savedLegends = [];
let currentLegendId = null;

// ================= INITIALIZATION =================

document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    loadSavedLegends();
    renderLegends(legendsData);
    
    // Set up event listeners
    document.getElementById('legendModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLegendModal();
        }
    });
});

// ================= FUNCTIONS =================

function loadSavedLegends() {
    const saved = localStorage.getItem('savedLegends');
    if (saved) {
        savedLegends = JSON.parse(saved);
    }
}

function saveSavedLegends() {
    localStorage.setItem('savedLegends', JSON.stringify(savedLegends));
}

function renderLegends(legends) {
    const container = document.getElementById('legendsContainer');
    
    if (legends.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <div class="empty-state-title">No legends found</div>
                <div class="empty-state-text">Try a different search or filter</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    legends.forEach(legend => {
        const isSaved = savedLegends.includes(legend.id);
        html += `
            <div class="card legend-card" data-id="${legend.id}">
                <img src="${legend.image}" 
                     alt="${legend.name}" 
                     class="card-image"
                     onerror="this.src='https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800'">
                <span class="legend-mood ${legend.mood}">${capitalizeFirst(legend.mood)}</span>
                <div class="card-details">
                    <span class="card-detail-item">üìç ${legend.location}</span>
                </div>
                <h3 class="card-title">${legend.name}</h3>
                <p class="legend-teaser">${legend.teaser}</p>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="openLegendModal(${legend.id})">üìú Read Legend</button>
                    <button class="btn ${isSaved ? 'btn-secondary' : 'btn-secondary'}" 
                            onclick="toggleSaveLegend(${legend.id})"
                            style="${isSaved ? 'background: #4caf50; color: white;' : ''}">
                        ${isSaved ? 'üíö Saved' : 'ü§ç Save'}
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterLegends(filter) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === filter || 
            (filter === 'all' && btn.textContent === 'All')) {
            btn.classList.add('active');
        }
    });
    
    // Filter legends
    if (filter === 'all') {
        renderLegends(legendsData);
    } else {
        const filtered = legendsData.filter(legend => legend.mood === filter);
        renderLegends(filtered);
    }
    
    // Close search if open
    document.getElementById('searchContainer').style.display = 'none';
}

function toggleSearch() {
    const searchContainer = document.getElementById('searchContainer');
    if (searchContainer.style.display === 'none') {
        searchContainer.style.display = 'block';
        document.getElementById('searchInput').focus();
    } else {
        searchContainer.style.display = 'none';
        document.getElementById('searchInput').value = '';
        renderLegends(legendsData);
    }
}

function searchLegends(query) {
    const searchTerm = query.toLowerCase().trim();
    
    if (!searchTerm) {
        filterLegends(currentFilter);
        return;
    }
    
    let filtered = legendsData.filter(legend => 
        legend.name.toLowerCase().includes(searchTerm) ||
        legend.location.toLowerCase().includes(searchTerm) ||
        legend.teaser.toLowerCase().includes(searchTerm) ||
        legend.mood.toLowerCase().includes(searchTerm)
    );
    
    // Also apply current filter
    if (currentFilter !== 'all') {
        filtered = filtered.filter(legend => legend.mood === currentFilter);
    }
    
    renderLegends(filtered);
}

function openLegendModal(id) {
    const legend = legendsData.find(l => l.id === id);
    if (!legend) return;
    
    currentLegendId = id;
    
    document.getElementById('modalImage').src = legend.image;
    document.getElementById('modalTitle').textContent = legend.name;
    document.getElementById('modalLocation').innerHTML = 'üìç ' + legend.location;
    
    const moodEl = document.getElementById('modalMood');
    moodEl.textContent = capitalizeFirst(legend.mood);
    moodEl.className = 'legend-mood ' + legend.mood;
    
    document.getElementById('modalContent').textContent = legend.content;
    
    // Render facts
    const factsContainer = document.getElementById('modalFacts');
    factsContainer.innerHTML = legend.facts.map(fact => 
        `<span class="legend-fact-tag">${fact}</span>`
    ).join('');
    
    document.getElementById('modalStories').textContent = legend.stories;
    
    document.getElementById('legendModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeLegendModal() {
    document.getElementById('legendModal').classList.remove('show');
    document.body.style.overflow = '';
    currentLegendId = null;
}

function toggleSaveLegend(id) {
    if (savedLegends.includes(id)) {
        savedLegends = savedLegends.filter(l => l !== id);
    } else {
        savedLegends.push(id);
    }
    
    saveSavedLegends();
    
    // Re-render to show updated save status
    if (document.getElementById('searchInput').value) {
        searchLegends(document.getElementById('searchInput').value);
    } else {
        filterLegends(currentFilter);
    }
}

function saveLegend() {
    if (currentLegendId && !savedLegends.includes(currentLegendId)) {
        savedLegends.push(currentLegendId);
        saveSavedLegends();
        alert('Legend saved to your collection!');
        
        // Re-render
        if (document.getElementById('searchInput').value) {
            searchLegends(document.getElementById('searchInput').value);
        } else {
            filterLegends(currentFilter);
        }
    } else {
        alert('This legend is already saved!');
    }
}

function shareLegend() {
    const legend = legendsData.find(l => l.id === currentLegendId);
    if (!legend) return;
    
    const shareText = `Check out this legend about ${legend.name}! ${legend.teaser}`;
    
    if (navigator.share) {
        navigator.share({
            title: legend.name + ' - TravelSync Legends',
            text: shareText,
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText + ' ' + window.location.href)
            .then(() => alert('Link copied to clipboard!'))
            .catch(() => alert('Could not copy link'));
    }
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLegendModal();
    }
});
